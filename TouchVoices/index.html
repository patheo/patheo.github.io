<html>
<head>
  <title>--TouchVoices--</title>

  <!-- Chargement des bibliothèques JS -->
  <script src="JS/libary/jquery-2.1.4.min.js"></script>
  <script src="JS/libary/interact.min.js"></script>
  <script src="JS/libary/jquery.knob.min.js"></script>
  <script src="JS/libary/p5.js"></script>

  <link rel="stylesheet" type="text/css" href="CSS/style.css" media="all"/>

</head>

<body>
<script src="JS/styleDial.js"></script>

<!-- Initialisation des objets
Les id correspondent au nom des objets Faust-->
<div id="fondEcran" style="position:absolute; left:0px;top:0px"></div>

<!-- Interface Métronome
Un Dial extérieur pour le Volume et un intérieur pour la vitesse-->
<div id="Met">
  <div id="MetVol">
    <input id="V"</input>
  </div>
  <div id="MetSpeed">
    <input id="S"</input>
  </div>
</div>

<!-- Les Noeuds
Chaque noeud porte l'adressage suivant :
      <num> = numero du noeud
      <num> = numero de l'effet
      <mov ou vol> = paramètre édité

    Pour les bontons = 0 1 2 3-->
<!-- Noeud 0 -->
<div id="0">
    <div id="00">0</div>
    <div id="01">1</div>
    <div id="02">2</div>
    <div id="03">3</div>
    <div id="0View">V</div>
  <div id="0Effect">
    <div id="04Mov"></br>1</div>
    <div id="05Mov"></br>2</div>
    <div id="06Mov"></br>3</div>
    <div id="07Mov"></br>4</div>
    <div id="08Mov"></br>5</div>
  </div>
  <input id="0Vol"></input>
  <div id="0Mov"></div>
</div>

<!-- Noeud 1 -->
<div id="1">
    <div id="10">0</div>
    <div id="11">1</div>
    <div id="12">2</div>
    <div id="13">3</div>
    <div id="1View">V</div>
  <div id="1Effect">
    <div id="14Mov"></br>1</div>
    <div id="15Mov"></br>2</div>
    <div id="16Mov"></br>3</div>
    <div id="17Mov"></br>4</div>
    <div id="18Mov"></br>5</div>
  </div>
  <input id="1Vol"></input>
  <div id="1Mov"></div>
</div>

<!-- Noeud 2 -->
<div id="2">
    <div id="20">0</div>
    <div id="21">1</div>
    <div id="22">2</div>
    <div id="23">3</div>
    <div id="2View">V</div>
  <div id="2Effect">
    <div id="24Mov"></br>1</div>
    <div id="25Mov"></br>2</div>
    <div id="26Mov"></br>3</div>
    <div id="27Mov"></br>4</div>
    <div id="28Mov"></br>5</div>
  </div>
  <input id="2Vol"></input>
  <div id="2Mov"></div>
</div>

<!-- Noeud 3 -->
<div id="3">
    <div id="30">0</div>
    <div id="31">1</div>
    <div id="32">2</div>
    <div id="33">3</div>
    <div id="3View">V</div>
  <div id="3Effect">
    <div id="34Mov"></br>1</div>
    <div id="35Mov"></br>2</div>
    <div id="36Mov"></br>3</div>
    <div id="37Mov"></br>4</div>
    <div id="38Mov"></br>5</div>
  </div>
  <input id="3Vol"></input>
  <div id="3Mov"></div>
</div>

<!-- Noeud 4 -->
<div id="4">
    <div id="40">0</div>
    <div id="41">1</div>
    <div id="42">2</div>
    <div id="43">3</div>
    <div id="4View">V</div>
  <div id="4Effect">
    <div id="44Mov"></br>1</div>
    <div id="45Mov"></br>2</div>
    <div id="46Mov"></br>3</div>
    <div id="47Mov"></br>4</div>
    <div id="48Mov"></br>5</div>
  </div>
  <input id="4Vol"></input>
  <div id="4Mov"></div>
</div>

<!-- Noeud 5 -->
<div id="5">
    <div id="50">0</div>
    <div id="51">1</div>
    <div id="52">2</div>
    <div id="53">3</div>
    <div id="5View">V</div>
  <div id="5Effect">
    <div id="54Mov"></br>1</div>
    <div id="55Mov"></br>2</div>
    <div id="56Mov"></br>3</div>
    <div id="57Mov"></br>4</div>
    <div id="58Mov"></br>5</div>
  </div>
  <input id="5Vol"></input>
  <div id="5Mov"></div>
</div>

<div id="loading">
  <h1> Bienvenue sur la page Web du projet TouchVoices </h1>
  <p>La page est en chargement... Merci de patienter...<br><br>
    Profitons en pour presenter comment marche cet outil...<br>
    En haut à gauche se trouve deux boutons qui gere le metronome de l'outil<br>
    > le bouton interieur s'occupe de la vitesse<br>
    > le bouton exterieur s'occupe du volume du metronome<br><br>
    Ensuite il y a 6 "pastilles", c'est par la que le son passe.<br>
    En les deplaçant les son va se deplacer autour de la tete de l'auditeur...<br>
    Autour des "pastilles", il y a 4 boutons :<br>
    Bouton 0 = Le micro est coupe<br>
    Bouton 1 = Le son du micro passe dans la pastille<br>
    Bouton 2 = Le son est enregistre (attention cette fonction ne marche que sur le click)<br>
    Bouton 3 = Le son enregistre est joue en boucle (attention cette fonction ne marche que sur le click)<br>
    Bouton V = Permet l'affichage des modules d'effet<br><br>
    Pour ce module il suffit de cliquer sur les rond pour activer les effets puis<br>
    de les deplacer dans le carre pour voir les modifications que cela fait.<br> <br>
    Cet outil est en cours de developement est utilise des technologies en cours d'experimentation <br>
    c'est pourquoi les temps de chargement peuvent être long et le son peut quelques fois se figer. <br><br>
    Projet realiser avec les bibliotheques Jquery.js, Interact.js et P5.js <br>
    et la couche audio est realise grace au language Faust.
  </p>
</div>

<script>
// Initialisation des attributs des Effets

"use strict"

var nbNoeud = 6;
var mouvement = 0;
var theta = 0;
var i;
var id;
var idx;
var vol = 10;

//Mise en place des couleurs de bases

var colorBgd = new Array;
colorBgd[0] = "rgba(255, 0, 125, 0.5)";
colorBgd[1] = "rgba(125, 255, 0, 0.5)";
colorBgd[2] = "rgba(0, 125, 255, 0.5)";
colorBgd[3] = "rgba(0, 255, 125, 0.5)";
colorBgd[4] = "rgba(125, 0, 255, 0.5)";
colorBgd[5] = "rgba(255, 125, 0, 0.5)";

var colorButReset = "rgba(255, 255, 255, 0.3)";
var colorBut = new Array;
colorBut[0] = "rgba(255, 255, 255, 0.1)";
colorBut[1] = "rgba(0, 0, 255, 0.5)";
colorBut[2] = "rgba(255, 0, 0, 0.5)";
colorBut[3] = "rgba(0, 255, 0, 0.5)";

// Définition de la chaine audio
var effet1 = [0, 0, 0, 0, "Sat", "Mun", "Del", "Fil", "Rev"];
var effet2 = [0, 0, 0, 0, "Fre", "Mun", "Res", "Rin", "Rev"];
var effet = effet1;
</script>

<script src="JS/formatageDiv.js"></script>
<script src="JS/interaction.js"></script>
<script src="JS/dessinP5.js"></script>
<script src="DSP/effetFaust.js"></script>

<script>
// Dféfinition de la fonction de fermeture du Div de chargement
function audioReady(){
  console.log("READY !!");
  $("#loading").fadeOut("slow");
}

// Mise en place de l'audio
var isWebKitAudio = (typeof (webkitAudioContext) !== "undefined");
var audio_context = (isWebKitAudio) ? new webkitAudioContext() : new AudioContext();
var audio_input = null;
var effetFaust = null;
var faustsvg = null;
var dsp_code = null;

function changeBufferSize(buffer_size)
{
    var new_buffer_size = buffer_size.options[buffer_size.selectedIndex].value;
    console.log(new_buffer_size);
    startNeweffetFaust(new_buffer_size);
}

// Audio input handling

function activateAudioInput()
{
    if (!navigator.getUserMedia) {
        navigator.getUserMedia = navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
    }

    if (navigator.getUserMedia) {
        navigator.getUserMedia({audio:true}, getDevice, function(e) {
                alert('Error getting audio input');
                console.log(e);
        });
    } else {
        alert('Audio input API not available');
    }
}

function getDevice(device)
{
    // Create an AudioNode from the stream.
    audio_input = audio_context.createMediaStreamSource(device);

    // Connect it to the destination.
    audio_input.connect(effetFaust.getProcessor());
}

function starteffetFaustAux(buffer_size)
{
    console.log("startAudioFX %d", buffer_size);
    if (effetFaust) {
        if (audio_input) {
            audio_input.disconnect(effetFaust.getProcessor());
        }
        _f4u$t.hard_delete(faustsvg);
        effetFaust.stop();
        effetFaust.destroy();
    }
    effetFaust = faust.effetFaust(audio_context, buffer_size);
    if (effetFaust.getNumInputs() > 0) {
        activateAudioInput();
    }
    effetFaust.start();
    console.log(effetFaust.json());
    console.log(effetFaust.controls());
}

function starteffetFaust()
{
    starteffetFaustAux(256);
}

function startNeweffetFaust(buffer_size)
{
    starteffetFaustAux(buffer_size);
}

// To activate audio on iOS
window.addEventListener('touchstart', function() {

	// create empty buffer
	var buffer = audio_context.createBuffer(1, 1, 22050);
	var source = audio_context.createBufferSource();
	source.buffer = buffer;

	// connect to output (your speakers)
	source.connect(audio_context.destination);

	// play the file
	source.noteOn(0);

}, false);

// General

$(starteffetFaust);

</script>

</body>
</html>
